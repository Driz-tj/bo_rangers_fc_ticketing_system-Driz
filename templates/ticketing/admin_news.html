{% extends 'base.html' %}

{% block title %}Manage News - Admin - Bo Rangers FC{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="bi bi-newspaper text-danger"></i> Manage News
                </h1>
                <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Add News Form -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-plus"></i> Add News Article
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="newsForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                <i class="bi bi-type"></i> Title *
                            </label>
                            {{ form.title }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                <i class="bi bi-tag"></i> Category *
                            </label>
                            {{ form.category }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.image.id_for_label }}" class="form-label">
                                <i class="bi bi-image"></i> Featured Image
                            </label>
                            {{ form.image }}
                            <div class="form-text">Optional. Recommended size: 800x400px</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.video.id_for_label }}" class="form-label">
                                <i class="bi bi-camera-video"></i> Featured Video
                            </label>
                            {{ form.video }}
                            <div class="form-text">Optional. Supported formats: MP4, WebM, Ogg</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.body.id_for_label }}" class="form-label">
                                <i class="bi bi-text-paragraph"></i> Article Content *
                            </label>
                            {{ form.body }}
                        </div>
                        
                        <div class="mb-3 form-check">
                            {{ form.is_featured }}
                            <label for="{{ form.is_featured.id_for_label }}" class="form-check-label">
                                <i class="bi bi-star"></i> Featured Article
                            </label>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-plus"></i> Publish Article
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- News List -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list"></i> Published Articles
                    </h5>
                    <span class="badge bg-primary">{{ news_articles|length }} article{{ news_articles|length|pluralize }}</span>
                </div>
                <div class="card-body">
                    {% if news_articles %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Author</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for article in news_articles %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if article.image %}
                                                        <img src="{{ article.image.url }}" alt="{{ article.title }}" 
                                                             class="me-2 rounded" style="width: 40px; height: 40px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="me-2 bg-secondary rounded d-flex align-items-center justify-content-center" 
                                                             style="width: 40px; height: 40px;">
                                                            <i class="bi bi-newspaper text-white"></i>
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <strong>{{ article.title|truncatechars:30 }}</strong>
                                                        {% if article.is_featured %}
                                                            <br><span class="badge bg-warning">
                                                                <i class="bi bi-star-fill"></i> Featured
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ article.get_category_display }}</span>
                                            </td>
                                            <td>{{ article.author.username }}</td>
                                            <td>
                                                {{ article.date_posted|date:"M d, Y" }}<br>
                                                <small class="text-muted">{{ article.date_posted|time:"H:i" }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Published
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'news_detail' article.id %}" class="btn btn-outline-primary btn-sm" target="_blank">
                                                        <i class="bi bi-eye"></i> View
                                                    </a>
                                                    <a href="{% url 'edit_news' article.id %}" class="btn btn-outline-warning btn-sm">
                                                        <i class="bi bi-pencil"></i> Edit
                                                    </a>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteArticle({{ article.id }}, '{{ article.title|escapejs }}')">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-newspaper text-muted" style="font-size: 4rem;"></i>
                            <h4 class="mt-3 text-muted">No articles published yet</h4>
                            <p class="text-muted">Start by creating your first news article.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="row mt-4">
                <div class="col-md-2">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>{{ total_articles }}</h4>
                            <p class="mb-0 small">Total</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h4>{{ featured_count }}</h4>
                            <p class="mb-0 small">Featured</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>{{ match_recap_count }}</h4>
                            <p class="mb-0 small">Match Recaps</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>{{ press_release_count }}</h4>
                            <p class="mb-0 small">Press Releases</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white">
                        <div class="card-body text-center">
                            <h4>{{ club_news_count }}</h4>
                            <p class="mb-0 small">Club News</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-dark text-white">
                        <div class="card-body text-center">
                            <h4>{{ general_count }}</h4>
                            <p class="mb-0 small">General</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    function deleteArticle(articleId, articleTitle) {
        if (confirm(`Are you sure you want to delete the article "${articleTitle}"? This action cannot be undone.`)) {
            fetch(`/delete-news/${articleId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create success alert
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
                    
                    // Reload page to reflect changes
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the article.');
            });
        }
    }
    
    // Form validation
    document.getElementById('newsForm').addEventListener('submit', function(e) {
        const title = document.getElementById('{{ form.title.id_for_label }}').value.trim();
        const body = document.getElementById('{{ form.body.id_for_label }}').value.trim();
        
        if (!title) {
            e.preventDefault();
            alert('Please enter a title for the article.');
            return;
        }
        
        if (!body) {
            e.preventDefault();
            alert('Please enter the article content.');
            return;
        }
        
        if (body.length < 50) {
            e.preventDefault();
            alert('Article content should be at least 50 characters long.');
            return;
        }
    });
    
    // Character counter for article body
    const bodyTextarea = document.getElementById('{{ form.body.id_for_label }}');
    if (bodyTextarea) {
        const counter = document.createElement('div');
        counter.className = 'form-text';
        counter.id = 'bodyCounter';
        bodyTextarea.parentNode.appendChild(counter);
        
        function updateCounter() {
            const length = bodyTextarea.value.length;
            counter.textContent = `${length} characters`;
            if (length < 50) {
                counter.className = 'form-text text-warning';
            } else {
                counter.className = 'form-text text-muted';
            }
        }
        
        bodyTextarea.addEventListener('input', updateCounter);
        updateCounter();
    }
</script>
{% endblock %}
{% endblock %}

